name: High_Level Whale Monitor (Manual Run Only)

on:
  workflow_dispatch:   # فقط اجرای دستی

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas requests loguru
          fi

      - name: Ensure folders exist
        run: |
          mkdir -p data logs

      - name: Run High_Level.py
        shell: bash
        run: |
          set -o pipefail
          python -u High_Level.py 2>&1 | tee run_script_output.log
          echo "${PIPESTATUS[0]}" > run_exit_code.txt

      # --- Artifacts & Debug ---

      - name: Upload run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: high-level-run-log
          path: run_script_output.log
          retention-days: 7
          if-no-files-found: warn

      - name: Upload data folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: high-level-data-folder
          path: data
          retention-days: 7
          if-no-files-found: warn

      - name: Upload latest CSV (separate)
        if: always()
        shell: bash
        run: |
          set -e
          LATEST=$(ls -t data/*.csv 2>/dev/null | head -n1 || true)
          if [ -n "$LATEST" ]; then
            echo "Latest CSV: $LATEST"
            cp "$LATEST" /tmp/latest_high_level.csv
          else
            echo "No CSV found in data/"
            # ساخت یک فایل خالی برای اینکه آرتیفکت همیشه وجود داشته باشد (اختیاری)
            echo "no csv generated" > /tmp/latest_high_level.csv
          fi
        # آرتیفکت فایل تکی
      - name: Upload latest_high_level.csv
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latest-high-level-csv
          path: /tmp/latest_high_level.csv
          retention-days: 7
          if-no-files-found: warn

      - name: Commit & push data + logs
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add -A data logs run_script_output.log run_exit_code.txt || true
          git commit -m "Manual run - update High_Level data & logs [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Nothing to push or push failed"
