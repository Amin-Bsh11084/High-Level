name: Hi-Level Whale Monitor (LBank) - High_Level

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: hi-level-lbank
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies (safe)
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install requests pandas loguru
        fi

    - name: Ensure logs & data folders exist
      run: |
        mkdir -p data logs

    - name: Run High_Level script
      run: |
        echo "ðŸš€ Starting High_Level..."
        python High_Level.py

    - name: Show run_log.txt
      run: |
        if [ -f logs/run_log.txt ]; then tail -n 200 logs/run_log.txt; fi
        if [ -f run_log.txt ]; then tail -n 200 run_log.txt; fi

    - name: Commit and push CSV & logs (if any)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git pull --rebase origin main || true
        git add data/data.csv logs/run_log.txt || echo "No files to add"
        git commit -m "Update whale data.csv [skip ci]" || echo "No changes to commit"
        git push origin main || echo "Nothing to push"

    - name: Debug and Show data CSV (safe)
      run: |
        echo "ðŸ“‚ data folder contents:"; ls -la data || echo "data missing"
        for f in data/*; do [ -e "$f" ] || continue; echo "---- $f ----"; stat -c '%n %s bytes' "$f" 2>/dev/null || true; head -n 20 "$f" || true; done
